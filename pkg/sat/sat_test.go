package sat

import (
	"encoding/xml"
	"fmt"
	"os"
	"testing"

	. "github.com/onsi/gomega"
	"github.com/rmohr/bazeldnf/pkg/api"
)

func TestRecursive(t *testing.T) {
	g := NewGomegaWithT(t)
	f, err := os.Open("testdata/perl-pathtools-fc32.xml")
	g.Expect(err).ToNot(HaveOccurred())
	defer f.Close()
	repo := &api.Repository{}
	err = xml.NewDecoder(f).Decode(repo)
	g.Expect(err).ToNot(HaveOccurred())

	for _, pkg := range repo.Packages {
		t.Run(fmt.Sprintf("find solution for %s", pkg.Name), func(t *testing.T) {
			g := NewGomegaWithT(t)
			resolver := NewResolver(false)
			packages := []*api.Package{}
			for i, _ := range repo.Packages {
				packages = append(packages, &repo.Packages[i])
			}
			err = resolver.LoadInvolvedPackages(packages, nil, nil)
			g.Expect(err).ToNot(HaveOccurred())
			err = resolver.ConstructRequirements([]string{pkg.Name})
			g.Expect(err).ToNot(HaveOccurred())
			_, _, _, err := resolver.Resolve()
			if err != nil {
				t.Fatalf("Failed to solve %s\n", pkg.Name)
			}
		})
	}
}

func Test(t *testing.T) {
	tests := []struct {
		name     string
		requires []string
		installs []string
		repofile string
		nobest   bool
		focus    bool
	}{
		{name: "should resolve bash",
			requires: []string{
				"bash",
				"fedora-release-server",
				"glibc-langpack-en",
			},
			installs: []string{
				"libgcc-0:10.2.1-1.fc32",
				"fedora-gpg-keys-0:32-6",
				"glibc-0:2.31-4.fc32",
				"glibc-langpack-en-0:2.31-4.fc32",
				"fedora-release-common-0:32-3",
				"glibc-common-0:2.31-4.fc32",
				"ncurses-base-0:6.1-15.20191109.fc32",
				"ncurses-libs-0:6.1-15.20191109.fc32",
				"fedora-release-server-0:32-3",
				"tzdata-0:2020a-1.fc32",
				"setup-0:2.13.6-2.fc32",
				"basesystem-0:11-9.fc32",
				"bash-0:5.0.17-1.fc32",
				"filesystem-0:3.14-2.fc32",
				"fedora-repos-0:32-6",
			},
			repofile: "testdata/bash-fc32.xml",
		},
		{
			name: "should resolve fedora-release-container",
			requires: []string{
				"fedora-release-container",
			},
			installs: []string{
				"fedora-gpg-keys-0:32-6",
				"fedora-repos-0:32-6",
				"fedora-release-container-0:32-3",
				"fedora-release-common-0:32-3",
			},
			nobest:   true,
			repofile: "testdata/fedora-release-container.xml",
		},
		{
			name: "should resolve libvirt-daemon-driver-storage-zfs",
			requires: []string{
				"libvirt-daemon-driver-storage-zfs",
				"glibc-langpack-en",
				"fedora-release-container",
				"coreutils-single",
				"libcurl-minimal",
				"libev",
				"libverto-libev",
			},
			installs: []string{
				"xz-libs-0:5.2.5-1.fc32",
				"libcap-ng-0:0.7.11-1.fc32",
				"openldap-0:2.4.47-5.fc32",
				"iproute-tc-0:5.7.0-1.fc32",
				"numactl-libs-0:2.0.12-4.fc32",
				"libssh2-0:1.9.0-5.fc32",
				"systemd-pam-0:245.8-2.fc32",
				"libnetfilter_conntrack-0:1.0.7-4.fc32",
				"glibc-common-0:2.31-4.fc32",
				"shadow-utils-2:4.8.1-2.fc32",
				"elfutils-libelf-0:0.181-1.fc32",
				"linux-atm-libs-0:2.5.1-26.fc32",
				"ncurses-base-0:6.1-15.20191109.fc32",
				"libvirt-daemon-driver-storage-core-0:6.1.0-4.fc32",
				"perl-PathTools-0:3.78-441.fc32",
				"libargon2-0:20171227-4.fc32",
				"util-linux-0:2.35.2-1.fc32",
				"fedora-release-common-0:32-3",
				"libverto-0:0.3.0-9.fc32",
				"libselinux-0:3.0-5.fc32",
				"perl-threads-shared-0:1.60-441.fc32",
				"cracklib-0:2.9.6-22.fc32",
				"libnfsidmap-1:2.5.1-4.rc4.fc32",
				"coreutils-single-0:8.32-4.fc32.1",
				"libtirpc-0:1.2.6-1.rc4.fc32",
				"kmod-libs-0:27-1.fc32",
				"libvirt-daemon-0:6.1.0-4.fc32",
				"systemd-0:245.8-2.fc32",
				"libacl-0:2.2.53-5.fc32",
				"libdb-0:5.3.28-40.fc32",
				"p11-kit-trust-0:0.23.21-2.fc32",
				"dbus-broker-0:24-1.fc32",
				"libnl3-0:3.5.0-2.fc32",
				"polkit-libs-0:0.116-7.fc32",
				"gssproxy-0:0.8.2-8.fc32",
				"python-setuptools-wheel-0:41.6.0-2.fc32",
				"pam-0:1.3.1-26.fc32",
				"zfs-fuse-0:0.7.2.2-14.fc32",
				"cyrus-sasl-lib-0:2.1.27-4.fc32",
				"libgcrypt-0:1.8.5-3.fc32",
				"libstdc++-0:10.2.1-1.fc32",
				"quota-nls-1:4.05-9.fc32",
				"libvirt-daemon-driver-storage-zfs-0:6.1.0-4.fc32",
				"libcollection-0:0.7.0-44.fc32",
				"gawk-0:5.0.1-7.fc32",
				"fuse-libs-0:2.9.9-9.fc32",
				"dbus-1:1.12.20-1.fc32",
				"openssl-libs-1:1.1.1g-1.fc32",
				"nettle-0:3.5.1-5.fc32",
				"libuuid-0:2.35.2-1.fc32",
				"libverto-libev-0:0.3.0-9.fc32",
				"popt-0:1.16-19.fc32",
				"libxcrypt-0:4.4.17-1.fc32",
				"glibc-langpack-en-0:2.31-4.fc32",
				"sed-0:4.5-5.fc32",
				"libref_array-0:0.1.5-44.fc32",
				"libwsman1-0:2.6.8-12.fc32",
				"libxml2-0:2.9.10-7.fc32",
				"ncurses-libs-0:6.1-15.20191109.fc32",
				"libffi-0:3.1-24.fc32",
				"dmidecode-1:3.2-5.fc32",
				"dbus-libs-1:1.12.20-1.fc32",
				"elfutils-libs-0:0.181-1.fc32",
				"lzo-0:2.10-2.fc32",
				"keyutils-libs-0:1.6-4.fc32",
				"fuse-0:2.9.9-9.fc32",
				"libevent-0:2.1.8-8.fc32",
				"python-pip-wheel-0:19.3.1-4.fc32",
				"libpwquality-0:1.4.2-2.fc32",
				"libmount-0:2.35.2-1.fc32",
				"crypto-policies-0:20200619-1.git781bbd4.fc32",
				"libblkid-0:2.35.2-1.fc32",
				"perl-parent-1:0.238-1.fc32",
				"gzip-0:1.10-2.fc32",
				"libpath_utils-0:0.2.1-44.fc32",
				"libsemanage-0:3.0-3.fc32",
				"libutempter-0:1.1.6-18.fc32",
				"perl-Exporter-0:5.74-2.fc32",
				"fedora-repos-0:32-6",
				"pcre2-syntax-0:10.35-6.fc32",
				"qemu-img-2:4.2.1-1.fc32",
				"device-mapper-libs-0:1.02.171-1.fc32",
				"libunistring-0:0.9.10-7.fc32",
				"basesystem-0:11-9.fc32",
				"mozjs60-0:60.9.0-5.fc32",
				"polkit-pkla-compat-0:0.1-16.fc32",
				"qrencode-libs-0:4.0.2-5.fc32",
				"fedora-release-container-0:32-3",
				"python3-0:3.8.5-5.fc32",
				"readline-0:8.0-4.fc32",
				"p11-kit-0:0.23.21-2.fc32",
				"libssh-config-0:0.9.5-1.fc32",
				"perl-libs-4:5.30.3-456.fc32",
				"pcre-0:8.44-1.fc32",
				"libmnl-0:1.0.4-11.fc32",
				"grep-0:3.3-4.fc32",
				"libini_config-0:1.3.1-44.fc32",
				"libev-0:4.31-2.fc32",
				"yajl-0:2.1.0-14.fc32",
				"fuse-common-0:3.9.1-1.fc32",
				"numad-0:0.5-31.20150602git.fc32",
				"gnutls-0:3.6.15-1.fc32",
				"polkit-0:0.116-7.fc32",
				"perl-Scalar-List-Utils-3:1.54-440.fc32",
				"glibc-0:2.31-4.fc32",
				"libaio-0:0.3.111-7.fc32",
				"zlib-0:1.2.11-21.fc32",
				"filesystem-0:3.14-2.fc32",
				"cyrus-sasl-0:2.1.27-4.fc32",
				"bash-0:5.0.17-1.fc32",
				"e2fsprogs-libs-0:1.45.5-3.fc32",
				"parted-0:3.3-3.fc32",
				"perl-File-Path-0:2.17-1.fc32",
				"which-0:2.21-19.fc32",
				"krb5-libs-0:1.18.2-22.fc32",
				"perl-Socket-4:2.030-1.fc32",
				"libtasn1-0:4.16.0-1.fc32",
				"libnfnetlink-0:1.0.1-17.fc32",
				"lz4-libs-0:1.9.1-2.fc32",
				"bzip2-libs-0:1.0.8-2.fc32",
				"cryptsetup-libs-0:2.3.4-1.fc32",
				"json-c-0:0.13.1-13.fc32",
				"perl-Carp-0:1.50-440.fc32",
				"libcurl-minimal-0:7.69.1-6.fc32",
				"libnghttp2-0:1.41.0-1.fc32",
				"perl-interpreter-4:5.30.3-456.fc32",
				"pcre2-0:10.35-6.fc32",
				"libseccomp-0:2.5.0-3.fc32",
				"perl-constant-0:1.33-441.fc32",
				"device-mapper-0:1.02.171-1.fc32",
				"libgpg-error-0:1.36-3.fc32",
				"libnsl2-0:1.2.0-6.20180605git4a062cf.fc32",
				"keyutils-0:1.6-4.fc32",
				"quota-1:4.05-9.fc32",
				"perl-Text-Tabs+Wrap-0:2013.0523-440.fc32",
				"nfs-utils-1:2.5.1-4.rc4.fc32",
				"libcom_err-0:1.45.5-3.fc32",
				"dbus-common-1:1.12.20-1.fc32",
				"python3-libs-0:3.8.5-5.fc32",
				"perl-threads-1:2.22-442.fc32",
				"gdbm-libs-1:1.18.1-3.fc32",
				"expat-0:2.2.8-2.fc32",
				"perl-Unicode-Normalize-0:1.26-440.fc32",
				"libpcap-14:1.9.1-3.fc32",
				"mpfr-0:4.0.2-5.fc32",
				"iptables-libs-0:1.8.4-9.fc32",
				"kmod-0:27-1.fc32",
				"rpcbind-0:1.2.5-5.rc1.fc32.1",
				"libidn2-0:2.3.0-2.fc32",
				"systemd-libs-0:245.8-2.fc32",
				"alternatives-0:1.11-6.fc32",
				"audit-libs-0:3.0-0.19.20191104git1c2f876.fc32",
				"fedora-gpg-keys-0:32-6",
				"libgcc-0:10.2.1-1.fc32",
				"acl-0:2.2.53-5.fc32",
				"cyrus-sasl-gssapi-0:2.1.27-4.fc32",
				"libsigsegv-0:2.11-10.fc32",
				"libbasicobjects-0:0.1.1-44.fc32",
				"libcap-0:2.26-7.fc32",
				"perl-macros-4:5.30.3-456.fc32",
				"iproute-0:5.7.0-1.fc32",
				"libattr-0:2.4.48-8.fc32",
				"glib2-0:2.64.5-1.fc32",
				"gmp-1:6.1.2-13.fc32",
				"nmap-ncat-2:7.80-4.fc32",
				"tzdata-0:2020a-1.fc32",
				"ca-certificates-0:2020.2.41-1.1.fc32",
				"perl-Errno-0:1.30-456.fc32",
				"libsmartcols-0:2.35.2-1.fc32",
				"sqlite-libs-0:3.33.0-1.fc32",
				"libssh-0:0.9.5-1.fc32",
				"perl-IO-0:1.40-456.fc32",
				"libfdisk-0:2.35.2-1.fc32",
				"psmisc-0:23.3-3.fc32",
				"libsepol-0:3.0-4.fc32",
				"elfutils-default-yama-scope-0:0.181-1.fc32",
				"libvirt-libs-0:6.1.0-4.fc32",
				"setup-0:2.13.6-2.fc32",
				"systemd-rpm-macros-0:245.8-2.fc32",
			},
			nobest:   false,
			repofile: "testdata/libvirt-daemon-driver-storage-zfs-fc32.xml",
		},
		{
			name: "should resolve perl-PathTools",
			requires: []string{
				"perl-PathTools",
				"glibc-langpack-en",
				"fedora-release-container",
			},
			installs: []string{
				"perl-Carp-0:1.50-440.fc32",
				"basesystem-0:11-9.fc32",
				"fedora-release-common-0:32-3",
				"perl-interpreter-4:5.30.3-456.fc32",
				"ncurses-base-0:6.1-15.20191109.fc32",
				"glibc-langpack-en-0:2.31-4.fc32",
				"perl-PathTools-0:3.78-441.fc32",
				"libgcc-0:10.2.1-1.fc32",
				"perl-Socket-4:2.030-1.fc32",
				"perl-Scalar-List-Utils-3:1.54-440.fc32",
				"perl-macros-4:5.30.3-456.fc32",
				"perl-libs-4:5.30.3-456.fc32",
				"setup-0:2.13.6-2.fc32",
				"fedora-release-container-0:32-3",
				"perl-Exporter-0:5.74-2.fc32",
				"perl-threads-shared-0:1.60-441.fc32",
				"perl-threads-1:2.22-442.fc32",
				"filesystem-0:3.14-2.fc32",
				"perl-IO-0:1.40-456.fc32",
				"tzdata-0:2020a-1.fc32",
				"perl-Unicode-Normalize-0:1.26-440.fc32",
				"fedora-gpg-keys-0:32-6",
				"bash-0:5.0.17-1.fc32",
				"perl-File-Path-0:2.17-1.fc32",
				"fedora-repos-0:32-6",
				"perl-Text-Tabs+Wrap-0:2013.0523-440.fc32",
				"glibc-common-0:2.31-4.fc32",
				"libxcrypt-0:4.4.17-1.fc32",
				"ncurses-libs-0:6.1-15.20191109.fc32",
				"perl-parent-1:0.238-1.fc32",
				"glibc-0:2.31-4.fc32",
				"perl-constant-0:1.33-441.fc32",
				"perl-Errno-0:1.30-456.fc32",
				"gdbm-libs-1:1.18.1-3.fc32",
			},
			nobest:   false,
			repofile: "testdata/perl-pathtools-fc32.xml",
		},
		{
			name: "should resolve libguestfs without specifying platform-python as a dependency",
			requires: []string{
				"libguestfs",
				"centos-stream-release",
				"glibc-langpack-en",
				"coreutils-single",
				"libcurl-minimal",
				"selinux-policy-targeted",
				"kernel-core",
				"sil-nuosu-fonts",
			},
			installs: []string{
				"selinux-policy-0:3.14.3-72.el8",
				"libtasn1-0:4.13-3.el8",
				"dmidecode-1:3.2-10.el8",
				"gnupg2-0:2.2.20-2.el8",
				"glib2-0:2.56.4-14.el8",
				"iptables-ebtables-0:1.8.4-19.el8",
				"bash-0:4.4.20-1.el8_4",
				"librados2-1:12.2.7-9.el8",
				"xkeyboard-config-0:2.28-1.el8",
				"python3-libsemanage-0:2.9-6.el8",
				"nfs-utils-1:2.3.3-42.el8",
				"gnutls-utils-0:3.6.16-4.el8",
				"polkit-0:0.115-12.el8",
				"boost-program-options-0:1.66.0-10.el8",
				"readline-0:7.0-10.el8",
				"libgcc-0:8.5.0-2.el8",
				"crypto-policies-0:20210617-1.gitc776d3e.el8",
				"iso-codes-0:3.79-2.el8",
				"graphite2-0:1.3.10-10.el8",
				"binutils-0:2.30-104.el8",
				"libnetfilter_conntrack-0:1.0.6-5.el8",
				"python3-libselinux-0:2.9-5.el8",
				"libXau-0:1.0.9-3.el8",
				"less-0:530-1.el8",
				"librbd1-1:12.2.7-9.el8",
				"nss-softokn-freebl-0:3.67.0-4.el8_4",
				"cairo-0:1.15.12-3.el8",
				"libnfnetlink-0:1.0.1-13.el8",
				"genisoimage-0:1.1.11-39.el8",
				"psmisc-0:23.1-5.el8",
				"libkcapi-0:1.2.0-2.el8",
				"mtools-0:4.0.18-14.el8",
				"iproute-tc-0:5.12.0-1.el8",
				"libsolv-0:0.7.17-2.el8",
				"python3-ply-0:3.9-9.el8",
				"isns-utils-libs-0:0.99-1.el8",
				"libnfsidmap-1:2.3.3-42.el8",
				"swtpm-tools-0:0.4.2-1.20201201git2df14e3.el8s",
				"libXfixes-0:5.0.3-7.el8",
				"iproute-0:5.12.0-1.el8",
				"xz-0:5.2.4-3.el8",
				"libutempter-0:1.1.6-14.el8",
				"sed-0:4.5-2.el8",
				"platform-python-pip-0:9.0.3-20.el8",
				"rpm-0:4.14.3-14.el8_4",
				"kmod-0:25-18.el8",
				"qemu-kvm-common-15:6.0.0-19.el8s",
				"dbus-common-1:1.12.8-14.el8",
				"krb5-libs-0:1.18.2-12.el8",
				"glusterfs-libs-0:6.0-49.1.el8",
				"boost-date-time-0:1.66.0-10.el8",
				"json-c-0:0.13.1-2.el8",
				"libevent-0:2.1.8-5.el8",
				"libattr-0:2.4.48-3.el8",
				"p11-kit-trust-0:0.23.22-1.el8",
				"elfutils-default-yama-scope-0:0.185-1.el8",
				"libnsl2-0:1.2.0-2.20180605git4a062cf.el8",
				"mesa-libGL-0:21.1.3-1.el8.0.1",
				"python3-audit-0:3.0-0.17.20191104git1c2f876.el8",
				"mesa-filesystem-0:21.1.3-1.el8.0.1",
				"gettext-0:0.19.8.1-17.el8",
				"swtpm-libs-0:0.4.2-1.20201201git2df14e3.el8s",
				"libusal-0:1.1.11-39.el8",
				"systemd-pam-0:239-48.el8",
				"libwayland-client-0:1.19.0-1.el8",
				"libzstd-0:1.4.4-1.el8",
				"ndctl-libs-0:71.1-2.el8",
				"zlib-0:1.2.11-17.el8",
				"coreutils-single-0:8.30-10.el8",
				"python3-libdnf-0:0.63.0-1.el8",
				"libyaml-0:0.1.7-5.el8",
				"libkcapi-hmaccalc-0:1.2.0-2.el8",
				"cryptsetup-libs-0:2.3.3-4.el8",
				"libcurl-minimal-0:7.61.1-18.el8",
				"libusbx-0:1.0.23-4.el8",
				"libgpg-error-0:1.31-1.el8",
				"mesa-libEGL-0:21.1.3-1.el8.0.1",
				"swtpm-0:0.4.2-1.20201201git2df14e3.el8s",
				"python3-rpm-0:4.14.3-14.el8_4",
				"python3-cryptography-0:3.2.1-5.el8",
				"pam-0:1.3.1-15.el8",
				"libvirt-daemon-driver-storage-iscsi-0:7.4.0-1.el8s",
				"keyutils-libs-0:1.5.10-9.el8",
				"gnutls-dane-0:3.6.16-4.el8",
				"bind-export-libs-32:9.11.26-4.el8_4",
				"dosfstools-0:4.1-6.el8",
				"kmod-libs-0:25-18.el8",
				"libepoxy-0:1.5.8-1.el8",
				"file-libs-0:5.33-20.el8",
				"libcap-0:2.26-4.el8",
				"libini_config-0:1.3.1-39.el8",
				"hwdata-0:0.314-8.9.el8",
				"libiscsi-0:1.18.0-8.module_el8.5.0+746+bbd5d70c",
				"dbus-tools-1:1.12.8-14.el8",
				"which-0:2.21-16.el8",
				"systemd-libs-0:239-48.el8",
				"libstdc++-0:8.5.0-2.el8",
				"libXxf86vm-0:1.1.4-9.el8",
				"daxctl-libs-0:71.1-2.el8",
				"boost-thread-0:1.66.0-10.el8",
				"netcf-libs-0:0.2.8-12.module_el8.5.0+746+bbd5d70c",
				"fribidi-0:1.0.4-8.el8",
				"yajl-0:2.1.0-10.el8",
				"nss-softokn-0:3.67.0-4.el8_4",
				"bzip2-libs-0:1.0.6-26.el8",
				"python3-six-0:1.11.0-8.el8",
				"libffi-0:3.1-22.el8",
				"polkit-libs-0:0.115-12.el8",
				"libmodulemd-0:2.12.1-1.el8",
				"libunistring-0:0.9.9-3.el8",
				"glusterfs-api-0:6.0-49.1.el8",
				"python3-libs-0:3.6.8-38.el8",
				"fuse-common-0:3.2.1-12.el8",
				"dnf-plugins-core-0:4.0.21-1.el8",
				"python3-cffi-0:1.11.5-5.el8",
				"libvisual-1:0.4.0-25.el8",
				"systemd-udev-0:239-48.el8",
				"procps-ng-0:3.3.15-6.el8",
				"boost-iostreams-0:1.66.0-10.el8",
				"libsigsegv-0:2.11-5.el8",
				"autogen-libopts-0:5.18.12-8.el8",
				"dhcp-libs-12:4.3.6-44.0.1.el8",
				"mpfr-0:3.1.6-1.el8",
				"pcre-0:8.42-6.el8",
				"dbus-libs-1:1.12.8-14.el8",
				"pixman-0:0.38.4-1.el8",
				"python36-0:3.6.8-37.module_el8.5.0+771+e5d9a225",
				"device-mapper-8:1.02.177-3.el8",
				"lsscsi-0:0.32-2.el8",
				"gdbm-libs-1:1.18-1.el8",
				"libglvnd-egl-1:1.3.2-1.el8",
				"sil-nuosu-fonts-0:2.200-2.el8",
				"libX11-common-0:1.6.8-4.el8",
				"grep-0:3.1-6.el8",
				"qemu-kvm-block-iscsi-15:6.0.0-19.el8s",
				"parted-0:3.2-38.el8",
				"libcomps-0:0.1.16-2.el8",
				"libvirt-daemon-kvm-0:7.4.0-1.el8s",
				"expat-0:2.2.5-4.el8",
				"libnftnl-0:1.1.5-4.el8",
				"util-linux-0:2.32.1-27.el8",
				"libicu-0:60.3-2.el8_1",
				"libsepol-0:2.9-2.el8",
				"userspace-rcu-0:0.10.1-4.el8",
				"e2fsprogs-0:1.45.6-2.el8",
				"pciutils-libs-0:3.7.0-1.el8",
				"libreport-filesystem-0:2.9.5-15.el8",
				"libdatrie-0:0.2.9-7.el8",
				"qemu-img-15:6.0.0-19.el8s",
				"iputils-0:20180629-7.el8",
				"seabios-bin-0:1.14.0-1.el8s",
				"xml-common-0:0.6.3-50.el8",
				"libuuid-0:2.32.1-27.el8",
				"libselinux-0:2.9-5.el8",
				"checkpolicy-0:2.9-1.el8",
				"libogg-2:1.3.2-10.el8",
				"libvirt-libs-0:7.4.0-1.el8s",
				"libdrm-0:2.4.106-2.el8",
				"cyrus-sasl-0:2.1.27-5.el8",
				"libksba-0:1.3.5-7.el8",
				"libidn2-0:2.2.0-1.el8",
				"trousers-0:0.3.15-1.el8",
				"libbasicobjects-0:0.1.1-39.el8",
				"libtirpc-0:1.1.4-5.el8",
				"gmp-1:6.1.2-10.el8",
				"libvirt-daemon-driver-storage-disk-0:7.4.0-1.el8s",
				"centos-gpg-keys-1:8-2.el8",
				"filesystem-0:3.8-6.el8",
				"iptables-0:1.8.4-19.el8",
				"libxcb-0:1.13.1-1.el8",
				"device-mapper-libs-8:1.02.177-3.el8",
				"selinux-policy-targeted-0:3.14.3-72.el8",
				"dbus-daemon-1:1.12.8-14.el8",
				"popt-0:1.18-1.el8",
				"fuse-libs-0:2.9.7-12.el8",
				"libmnl-0:1.0.4-6.el8",
				"libcollection-0:0.7.0-39.el8",
				"nss-0:3.67.0-4.el8_4",
				"quota-1:4.04-14.el8",
				"quota-nls-1:4.04-14.el8",
				"cyrus-sasl-lib-0:2.1.27-5.el8",
				"libgcrypt-0:1.8.5-6.el8",
				"dnf-0:4.7.0-1.el8",
				"syslinux-nonlinux-0:6.04-5.el8",
				"libXv-0:1.0.11-7.el8",
				"libpath_utils-0:0.2.1-39.el8",
				"elfutils-libelf-0:0.185-1.el8",
				"edk2-ovmf-0:20200602gitca407c7246bf-4.el8",
				"celt051-0:0.5.1.3-15.el8",
				"libglvnd-glx-1:1.3.2-1.el8",
				"libpwquality-0:1.4.4-3.el8",
				"libfdisk-0:2.32.1-27.el8",
				"glusterfs-0:6.0-49.1.el8",
				"libvorbis-1:1.3.6-2.el8",
				"libmount-0:2.32.1-27.el8",
				"attr-0:2.4.48-3.el8",
				"libvirt-daemon-driver-secret-0:7.4.0-1.el8s",
				"boost-system-0:1.66.0-10.el8",
				"linux-firmware-0:20201218-102.git05789708.el8",
				"mdevctl-0:0.78-1.el8",
				"glibc-langpack-en-0:2.28-161.el8",
				"opus-0:1.3-0.4.beta.el8",
				"e2fsprogs-libs-0:1.45.6-2.el8",
				"librepo-0:1.14.0-2.el8",
				"mdadm-0:4.2-rc1_2.el8",
				"libdb-utils-0:5.3.28-40.el8",
				"chkconfig-0:1.13-2.el8",
				"centos-stream-repos-0:8-2.el8",
				"libssh-0:0.9.4-3.el8",
				"libtpms-0:0.7.4-4.20201106git2452a24dab.el8s",
				"gettext-libs-0:0.19.8.1-17.el8",
				"fontpackages-filesystem-0:1.44-22.el8",
				"platform-python-setuptools-0:39.2.0-6.el8",
				"libvirt-daemon-driver-storage-0:7.4.0-1.el8s",
				"python3-policycoreutils-0:2.9-14.el8",
				"libassuan-0:2.5.1-3.el8",
				"libpng-2:1.6.34-5.el8",
				"rpm-plugin-selinux-0:4.14.3-14.el8_4",
				"libvirt-daemon-driver-storage-logical-0:7.4.0-1.el8s",
				"libXft-0:2.3.3-1.el8",
				"gstreamer1-0:1.16.1-2.el8",
				"harfbuzz-0:1.7.5-3.el8",
				"qemu-kvm-core-15:6.0.0-19.el8s",
				"libthai-0:0.1.27-2.el8",
				"ca-certificates-0:2021.2.50-82.el8",
				"npth-0:1.5-4.el8",
				"policycoreutils-0:2.9-14.el8",
				"python3-setuptools-wheel-0:39.2.0-6.el8",
				"libvirt-daemon-driver-interface-0:7.4.0-1.el8s",
				"mesa-dri-drivers-0:21.1.3-1.el8.0.1",
				"qemu-kvm-ui-opengl-15:6.0.0-19.el8s",
				"iscsi-initiator-utils-iscsiuio-0:6.2.1.4-3.git095f59c.el8",
				"dbus-glib-0:0.110-2.el8",
				"supermin-0:5.2.1-1.el8s",
				"basesystem-0:11-5.el8",
				"usbredir-0:0.8.0-1.el8",
				"spice-server-0:0.14.3-4.el8",
				"libvirt-daemon-driver-storage-rbd-0:7.4.0-1.el8s",
				"augeas-libs-0:1.12.0-6.el8",
				"libgomp-0:8.5.0-2.el8",
				"glibc-common-0:2.28-161.el8",
				"python3-dateutil-1:2.6.1-6.el8",
				"alsa-lib-0:1.2.5-4.el8",
				"boost-random-0:1.66.0-10.el8",
				"python3-hawkey-0:0.63.0-1.el8",
				"findutils-1:4.6.0-20.el8",
				"numad-0:0.5-26.20150602git.el8",
				"libblkid-0:2.32.1-27.el8",
				"libvirt-daemon-driver-nwfilter-0:7.4.0-1.el8s",
				"nspr-0:4.31.0-1.el8_4",
				"trousers-lib-0:0.3.15-1.el8",
				"snappy-0:1.1.8-3.el8",
				"libglvnd-gles-1:1.3.2-1.el8",
				"python3-pyyaml-0:3.12-12.el8",
				"libglvnd-1:1.3.2-1.el8",
				"python3-setuptools-0:39.2.0-6.el8",
				"boost-atomic-0:1.66.0-10.el8",
				"gdbm-1:1.18-1.el8",
				"dnsmasq-0:2.79-15.el8",
				"dracut-0:049-136.git20210426.el8",
				"cryptsetup-0:2.3.3-4.el8",
				"gdisk-0:1.0.3-6.el8",
				"libseccomp-0:2.5.1-1.el8",
				"fuse-0:2.9.7-12.el8",
				"gnutls-0:3.6.16-4.el8",
				"openldap-0:2.4.46-17.el8_4",
				"sqlite-libs-0:3.26.0-15.el8",
				"syslinux-extlinux-0:6.04-5.el8",
				"glibc-0:2.28-161.el8",
				"oniguruma-0:6.8.2-2.el8",
				"libsemanage-0:2.9-6.el8",
				"rpm-libs-0:4.14.3-14.el8_4",
				"mozjs60-0:60.9.0-4.el8",
				"libX11-xcb-0:1.6.8-4.el8",
				"libxkbcommon-0:0.9.1-1.el8",
				"libpcap-14:1.9.1-5.el8",
				"dbus-1:1.12.8-14.el8",
				"libvirt-daemon-driver-nodedev-0:7.4.0-1.el8s",
				"fontconfig-0:2.13.1-3.el8",
				"rpcbind-0:1.2.5-8.el8",
				"libxshmfence-0:1.3-2.el8",
				"cpio-0:2.12-10.el8",
				"libX11-0:1.6.8-4.el8",
				"libverto-libevent-0:0.3.0-5.el8",
				"python3-dnf-plugins-core-0:4.0.21-1.el8",
				"qemu-kvm-block-curl-15:6.0.0-19.el8s",
				"lz4-libs-0:1.8.3-3.el8",
				"libsmartcols-0:2.32.1-27.el8",
				"tpm2-tss-0:2.3.2-4.el8",
				"mesa-libgbm-0:21.1.3-1.el8.0.1",
				"lvm2-8:2.03.12-3.el8",
				"device-mapper-persistent-data-0:0.9.0-1.el8",
				"systemd-0:239-48.el8",
				"python3-pip-wheel-0:9.0.3-20.el8",
				"nss-util-0:3.67.0-4.el8_4",
				"ncurses-base-0:6.1-9.20180224.el8",
				"platform-python-0:3.6.8-38.el8",
				"libvirt-daemon-driver-storage-mpath-0:7.4.0-1.el8s",
				"qemu-kvm-block-ssh-15:6.0.0-19.el8s",
				"rpm-build-libs-0:4.14.3-14.el8_4",
				"bzip2-0:1.0.6-26.el8",
				"lua-libs-0:5.3.4-11.el8",
				"python3-pip-0:9.0.3-20.el8",
				"libcap-ng-0:0.7.11-1.el8",
				"libselinux-utils-0:2.9-5.el8",
				"mesa-libglapi-0:21.1.3-1.el8.0.1",
				"setup-0:2.12.2-6.el8",
				"gpgme-0:1.13.1-9.el8",
				"device-mapper-multipath-libs-0:0.8.4-13.el8",
				"python3-libcomps-0:0.1.16-2.el8",
				"syslinux-extlinux-nonlinux-0:6.04-5.el8",
				"device-mapper-event-libs-8:1.02.177-3.el8",
				"libvirt-daemon-0:7.4.0-1.el8s",
				"curl-0:7.61.1-18.el8",
				"cracklib-0:2.9.6-15.el8",
				"p11-kit-0:0.23.22-1.el8",
				"gssproxy-0:0.8.0-19.el8",
				"libpmem-0:1.9.2-1.module_el8.5.0+756+4cdc1762",
				"libwayland-server-0:1.19.0-1.el8",
				"systemd-container-0:239-48.el8",
				"gawk-0:4.2.1-2.el8",
				"rdma-core-0:35.0-1.el8",
				"python3-gpg-0:1.13.1-9.el8",
				"python3-pycparser-0:2.14-14.el8",
				"libcroco-0:0.6.12-4.el8_2.1",
				"dhcp-common-12:4.3.6-44.0.1.el8",
				"nss-sysinit-0:3.67.0-4.el8_4",
				"lzop-0:1.03-20.el8",
				"syslinux-0:6.04-5.el8",
				"librdmacm-0:35.0-1.el8",
				"python3-dnf-0:4.7.0-1.el8",
				"dhcp-client-12:4.3.6-44.0.1.el8",
				"jq-0:1.5-12.el8",
				"libibverbs-0:35.0-1.el8",
				"gstreamer1-plugins-base-0:1.16.1-2.el8",
				"qemu-kvm-block-rbd-15:6.0.0-19.el8s",
				"libjpeg-turbo-0:1.5.3-11.el8",
				"libwayland-cursor-0:1.19.0-1.el8",
				"squashfs-tools-0:4.3-20.el8",
				"libnghttp2-0:1.33.0-3.el8_2.1",
				"file-0:5.33-20.el8",
				"libvirt-daemon-driver-storage-core-0:7.4.0-1.el8s",
				"tar-2:1.30-5.el8",
				"ima-evm-utils-0:1.3.2-12.el8",
				"keyutils-0:1.5.10-9.el8",
				"qemu-kvm-ui-spice-15:6.0.0-19.el8s",
				"hivex-0:1.3.18-21.module_el8.5.0+821+97472045",
				"python3-setools-0:4.3.0-2.el8",
				"radvd-0:2.17-15.el8",
				"libvirt-daemon-driver-storage-iscsi-direct-0:7.4.0-1.el8s",
				"acl-0:2.2.53-1.el8",
				"pango-0:1.42.4-8.el8",
				"policycoreutils-python-utils-0:2.9-14.el8",
				"libXext-0:1.3.4-1.el8",
				"orc-0:0.4.28-3.el8",
				"lzo-0:2.08-14.el8",
				"lvm2-libs-8:2.03.12-3.el8",
				"diffutils-0:3.6-6.el8",
				"ncurses-libs-0:6.1-9.20180224.el8",
				"libXrender-0:0.9.10-7.el8",
				"shadow-utils-2:4.6-13.el8",
				"ipxe-roms-qemu-0:20181214-8.git133f4c47.el8",
				"libarchive-0:3.3.3-1.el8",
				"llvm-libs-0:12.0.0-1.module_el8.5.0+840+21214faf",
				"libacl-0:2.2.53-1.el8",
				"kernel-core-0:4.18.0-315.el8",
				"elfutils-libs-0:0.185-1.el8",
				"gzip-0:1.9-12.el8",
				"libdb-0:5.3.28-40.el8",
				"jansson-0:2.11-3.el8",
				"libvirt-daemon-driver-network-0:7.4.0-1.el8s",
				"info-0:6.5-6.el8",
				"scrub-0:2.5.2-14.el8",
				"libtheora-1:1.1.1-21.el8",
				"libguestfs-1:1.44.0-3.el8s",
				"centos-stream-release-0:8.5-3.el8",
				"cyrus-sasl-gssapi-0:2.1.27-5.el8",
				"dnf-data-0:4.7.0-1.el8",
				"seavgabios-bin-0:1.14.0-1.el8s",
				"nettle-0:3.4.1-5.el8",
				"nmap-ncat-2:7.70-5.el8",
				"libdnf-0:0.63.0-1.el8",
				"libaio-0:0.3.112-1.el8",
				"libvirt-daemon-driver-storage-scsi-0:7.4.0-1.el8s",
				"qemu-kvm-block-gluster-15:6.0.0-19.el8s",
				"libxslt-0:1.1.32-6.el8",
				"iptables-libs-0:1.8.4-19.el8",
				"iscsi-initiator-utils-0:6.2.1.4-3.git095f59c.el8",
				"libxml2-0:2.9.7-11.el8",
				"libvirt-daemon-driver-storage-gluster-0:7.4.0-1.el8s",
				"libverto-0:0.3.0-5.el8",
				"device-mapper-event-8:1.02.177-3.el8",
				"tzdata-0:2021a-1.el8",
				"qemu-kvm-15:6.0.0-19.el8s",
				"xz-libs-0:5.2.4-3.el8",
				"pciutils-0:3.7.0-1.el8",
				"libcom_err-0:1.45.6-2.el8",
				"glusterfs-cli-0:6.0-49.1.el8",
				"ipcalc-0:0.2.4-4.el8",
				"libvirt-daemon-driver-qemu-0:7.4.0-1.el8s",
				"libpciaccess-0:0.14-1.el8",
				"libwayland-egl-0:1.19.0-1.el8",
				"numactl-libs-0:2.0.12-13.el8",
				"glusterfs-client-xlators-0:6.0-49.1.el8",
				"libssh-config-0:0.9.4-3.el8",
				"python3-dbus-0:1.2.4-15.el8",
				"openssl-libs-1:1.1.1k-1.el8",
				"boost-regex-0:1.66.0-10.el8",
				"libmetalink-0:0.1.3-7.el8",
				"cracklib-dicts-0:2.9.6-15.el8",
				"crypto-policies-scripts-0:20210617-1.gitc776d3e.el8",
				"pcre2-0:10.32-2.el8",
				"sgabios-bin-1:0.20170427git-3.module_el8.5.0+746+bbd5d70c",
				"polkit-pkla-compat-0:0.1-12.el8",
				"unbound-libs-0:1.7.3-17.el8",
				"freetype-0:2.9.1-4.el8_3.1",
				"libxcrypt-0:4.1.1-6.el8",
				"boost-chrono-0:1.66.0-10.el8",
				"libnl3-0:3.5.0-1.el8",
				"libss-0:1.45.6-2.el8",
				"audit-libs-0:3.0-0.17.20191104git1c2f876.el8",
				"libref_array-0:0.1.5-39.el8",
			},
			nobest:   false,
			repofile: "testdata/libguestfs-el8.xml",
		},
		{
			name: "should resolve libvirt-devel on centos stream",
			requires: []string{
				"libvirt-devel",
				"centos-stream-release",
				"glibc-langpack-en",
				"coreutils-single",
				"libcurl-minimal",
			},
			installs: []string{
				"libssh-0:0.9.4-3.el8",
				"ca-certificates-0:2021.2.50-82.el8",
				"nettle-0:3.4.1-4.el8_3",
				"glibc-langpack-en-0:2.28-158.el8",
				"json-c-0:0.13.1-2.el8",
				"keyutils-libs-0:1.5.10-6.el8",
				"glib2-0:2.56.4-13.el8",
				"zlib-0:1.2.11-17.el8",
				"openldap-0:2.4.46-17.el8_4",
				"libxcrypt-0:4.1.1-6.el8",
				"chkconfig-0:1.13-2.el8",
				"shadow-utils-2:4.6-13.el8",
				"setup-0:2.12.2-6.el8",
				"yajl-0:2.1.0-10.el8",
				"libdb-0:5.3.28-40.el8",
				"libcom_err-0:1.45.6-1.el8",
				"centos-stream-repos-0:8-2.el8",
				"bzip2-libs-0:1.0.6-26.el8",
				"gnutls-0:3.6.14-8.el8_3",
				"cryptsetup-libs-0:2.3.3-4.el8",
				"glibc-0:2.28-158.el8",
				"systemd-0:239-45.el8_4.1",
				"cyrus-sasl-gssapi-0:2.1.27-5.el8",
				"krb5-libs-0:1.18.2-12.el8",
				"libtirpc-0:1.1.4-5.el8",
				"bash-0:4.4.20-1.el8_4",
				"basesystem-0:11-5.el8",
				"dbus-libs-1:1.12.8-14.el8",
				"mpfr-0:3.1.6-1.el8",
				"libverto-0:0.3.0-5.el8",
				"rdma-core-0:35.0-1.el8",
				"coreutils-single-0:8.30-10.el8",
				"libmount-0:2.32.1-27.el8",
				"kmod-libs-0:25-18.el8",
				"libpkgconf-0:1.4.2-1.el8",
				"libibverbs-0:35.0-1.el8",
				"libutempter-0:1.1.6-14.el8",
				"sed-0:4.5-2.el8",
				"dbus-tools-1:1.12.8-14.el8",
				"dbus-1:1.12.8-14.el8",
				"readline-0:7.0-10.el8",
				"cracklib-0:2.9.6-15.el8",
				"libzstd-0:1.4.4-1.el8",
				"libtasn1-0:4.13-3.el8",
				"xz-libs-0:5.2.4-3.el8",
				"audit-libs-0:3.0-0.17.20191104git1c2f876.el8",
				"tzdata-0:2021a-1.el8",
				"pam-0:1.3.1-15.el8",
				"libcap-ng-0:0.7.11-1.el8",
				"libgcrypt-0:1.8.5-5.el8",
				"ncurses-base-0:6.1-9.20180224.el8",
				"gawk-0:4.2.1-2.el8",
				"device-mapper-8:1.02.177-2.el8",
				"cracklib-dicts-0:2.9.6-15.el8",
				"systemd-libs-0:239-45.el8_4.1",
				"pkgconf-m4-0:1.4.2-1.el8",
				"pciutils-libs-0:3.7.0-1.el8",
				"centos-stream-release-0:8.5-3.el8",
				"numactl-libs-0:2.0.12-13.el8",
				"dbus-daemon-1:1.12.8-14.el8",
				"libacl-0:2.2.53-1.el8",
				"device-mapper-libs-8:1.02.177-2.el8",
				"libssh-config-0:0.9.4-3.el8",
				"elfutils-default-yama-scope-0:0.185-1.el8",
				"libunistring-0:0.9.9-3.el8",
				"util-linux-0:2.32.1-27.el8",
				"acl-0:2.2.53-1.el8",
				"gzip-0:1.9-12.el8",
				"p11-kit-trust-0:0.23.22-1.el8",
				"libselinux-0:2.9-5.el8",
				"popt-0:1.18-1.el8",
				"lz4-libs-0:1.8.3-3.el8",
				"libblkid-0:2.32.1-27.el8",
				"cyrus-sasl-0:2.1.27-5.el8",
				"libgcc-0:8.5.0-2.el8",
				"libnsl2-0:1.2.0-2.20180605git4a062cf.el8",
				"glibc-common-0:2.28-158.el8",
				"systemd-pam-0:239-45.el8_4.1",
				"libsemanage-0:2.9-6.el8",
				"libcurl-minimal-0:7.61.1-18.el8",
				"libxml2-0:2.9.7-11.el8",
				"libseccomp-0:2.5.1-1.el8",
				"crypto-policies-0:20210209-1.gitbfb6bed.el8_3",
				"libsigsegv-0:2.11-5.el8",
				"pkgconf-pkg-config-0:1.4.2-1.el8",
				"libfdisk-0:2.32.1-27.el8",
				"openssl-libs-1:1.1.1k-1.el8",
				"libsmartcols-0:2.32.1-27.el8",
				"libidn2-0:2.2.0-1.el8",
				"pcre-0:8.42-6.el8",
				"libffi-0:3.1-22.el8",
				"grep-0:3.1-6.el8",
				"pkgconf-0:1.4.2-1.el8",
				"pcre2-0:10.32-2.el8",
				"elfutils-libelf-0:0.185-1.el8",
				"libuuid-0:2.32.1-27.el8",
				"libnl3-0:3.5.0-1.el8",
				"libpcap-14:1.9.1-5.el8",
				"libattr-0:2.4.48-3.el8",
				"p11-kit-0:0.23.22-1.el8",
				"pciutils-0:3.7.0-1.el8",
				"expat-0:2.2.5-4.el8",
				"libnghttp2-0:1.33.0-3.el8_2.1",
				"libpwquality-0:1.4.4-3.el8",
				"filesystem-0:3.8-4.el8.0.1",
				"dbus-common-1:1.12.8-14.el8",
				"ncurses-libs-0:6.1-9.20180224.el8",
				"libvirt-libs-0:7.0.0-14.1.el8",
				"libcap-0:2.26-4.el8",
				"libvirt-devel-0:7.0.0-14.1.el8",
				"cyrus-sasl-lib-0:2.1.27-5.el8",
				"info-0:6.5-6.el8",
				"centos-gpg-keys-1:8-2.el8",
				"gmp-1:6.1.2-10.el8",
				"iptables-libs-0:1.8.4-17.el8",
				"hwdata-0:0.314-8.8.el8",
				"libgpg-error-0:1.31-1.el8",
				"elfutils-libs-0:0.185-1.el8",
				"libsepol-0:2.9-2.el8",
			},
			nobest:   false,
			repofile: "testdata/libvirt-devel-el8.xml",
		},
		{
			name: "should resolve libvirt-devel on fedora",
			requires: []string{
				"libvirt-devel",
				"fedora-release-server",
				"glibc-langpack-en",
				"coreutils-single",
				"libcurl-minimal",
			},
			installs: []string{
				"json-c-0:0.13.1-13.fc32",
				"elfutils-libs-0:0.181-1.fc32",
				"libssh-config-0:0.9.5-1.fc32",
				"dbus-1:1.12.20-1.fc32",
				"coreutils-single-0:8.32-4.fc32.1",
				"krb5-libs-0:1.18.2-22.fc32",
				"libnghttp2-0:1.41.0-1.fc32",
				"systemd-0:245.8-2.fc32",
				"lz4-libs-0:1.9.1-2.fc32",
				"glibc-langpack-en-0:2.31-4.fc32",
				"yajl-0:2.1.0-14.fc32",
				"p11-kit-trust-0:0.23.21-2.fc32",
				"libvirt-libs-0:6.1.0-4.fc32",
				"libnetfilter_conntrack-0:1.0.7-4.fc32",
				"gzip-0:1.10-2.fc32",
				"gnutls-0:3.6.15-1.fc32",
				"cyrus-sasl-lib-0:2.1.27-4.fc32",
				"dbus-common-1:1.12.20-1.fc32",
				"ncurses-libs-0:6.1-15.20191109.fc32",
				"readline-0:8.0-4.fc32",
				"zlib-0:1.2.11-21.fc32",
				"libcom_err-0:1.45.5-3.fc32",
				"mpfr-0:4.0.2-5.fc32",
				"keyutils-libs-0:1.6-4.fc32",
				"systemd-rpm-macros-0:245.8-2.fc32",
				"glibc-common-0:2.31-4.fc32",
				"libpwquality-0:1.4.2-2.fc32",
				"libcap-ng-0:0.7.11-1.fc32",
				"libargon2-0:20171227-4.fc32",
				"alternatives-0:1.11-6.fc32",
				"fedora-release-server-0:32-3",
				"basesystem-0:11-9.fc32",
				"cyrus-sasl-0:2.1.27-4.fc32",
				"libnfnetlink-0:1.0.1-17.fc32",
				"cracklib-0:2.9.6-22.fc32",
				"libgcc-0:10.2.1-1.fc32",
				"glibc-0:2.31-4.fc32",
				"kmod-libs-0:27-1.fc32",
				"ncurses-base-0:6.1-15.20191109.fc32",
				"libtasn1-0:4.16.0-1.fc32",
				"cryptsetup-libs-0:2.3.4-1.fc32",
				"fedora-release-common-0:32-3",
				"libseccomp-0:2.5.0-3.fc32",
				"pkgconf-pkg-config-0:1.6.3-3.fc32",
				"openldap-0:2.4.47-5.fc32",
				"device-mapper-libs-0:1.02.171-1.fc32",
				"libssh2-0:1.9.0-5.fc32",
				"openssl-libs-1:1.1.1g-1.fc32",
				"libnl3-0:3.5.0-2.fc32",
				"bzip2-libs-0:1.0.8-2.fc32",
				"systemd-pam-0:245.8-2.fc32",
				"libxml2-0:2.9.10-7.fc32",
				"libidn2-0:2.3.0-2.fc32",
				"nettle-0:3.5.1-5.fc32",
				"device-mapper-0:1.02.171-1.fc32",
				"ca-certificates-0:2020.2.41-1.1.fc32",
				"qrencode-libs-0:4.0.2-5.fc32",
				"acl-0:2.2.53-5.fc32",
				"cyrus-sasl-gssapi-0:2.1.27-4.fc32",
				"libvirt-devel-0:6.1.0-4.fc32",
				"libffi-0:3.1-24.fc32",
				"libsepol-0:3.0-4.fc32",
				"libcap-0:2.26-7.fc32",
				"libsmartcols-0:2.35.2-1.fc32",
				"libmount-0:2.35.2-1.fc32",
				"libtirpc-0:1.2.6-1.rc4.fc32",
				"libverto-0:0.3.0-9.fc32",
				"fedora-repos-0:32-6",
				"gawk-0:5.0.1-7.fc32",
				"elfutils-libelf-0:0.181-1.fc32",
				"libssh-0:0.9.5-1.fc32",
				"libdb-0:5.3.28-40.fc32",
				"systemd-libs-0:245.8-2.fc32",
				"pcre2-syntax-0:10.35-6.fc32",
				"xz-libs-0:5.2.5-1.fc32",
				"pcre-0:8.44-1.fc32",
				"tzdata-0:2020a-1.fc32",
				"libacl-0:2.2.53-5.fc32",
				"libpcap-14:1.9.1-3.fc32",
				"pam-0:1.3.1-26.fc32",
				"pcre2-0:10.35-6.fc32",
				"libgcrypt-0:1.8.5-3.fc32",
				"bash-0:5.0.17-1.fc32",
				"setup-0:2.13.6-2.fc32",
				"libattr-0:2.4.48-8.fc32",
				"iptables-libs-0:1.8.4-9.fc32",
				"filesystem-0:3.14-2.fc32",
				"libunistring-0:0.9.10-7.fc32",
				"libselinux-0:3.0-5.fc32",
				"libmnl-0:1.0.4-11.fc32",
				"shadow-utils-2:4.8.1-2.fc32",
				"glib2-0:2.64.5-1.fc32",
				"libfdisk-0:2.35.2-1.fc32",
				"crypto-policies-0:20200619-1.git781bbd4.fc32",
				"libwsman1-0:2.6.8-12.fc32",
				"libsigsegv-0:2.11-10.fc32",
				"libuuid-0:2.35.2-1.fc32",
				"libcurl-minimal-0:7.69.1-6.fc32",
				"p11-kit-0:0.23.21-2.fc32",
				"util-linux-0:2.35.2-1.fc32",
				"grep-0:3.3-4.fc32",
				"dbus-broker-0:24-1.fc32",
				"fedora-gpg-keys-0:32-6",
				"libgpg-error-0:1.36-3.fc32",
				"dbus-libs-1:1.12.20-1.fc32",
				"numactl-libs-0:2.0.12-4.fc32",
				"elfutils-default-yama-scope-0:0.181-1.fc32",
				"audit-libs-0:3.0-0.19.20191104git1c2f876.fc32",
				"gmp-1:6.1.2-13.fc32",
				"libsemanage-0:3.0-3.fc32",
				"libxcrypt-0:4.4.17-1.fc32",
				"pkgconf-m4-0:1.6.3-3.fc32",
				"pkgconf-0:1.6.3-3.fc32",
				"libpkgconf-0:1.6.3-3.fc32",
				"expat-0:2.2.8-2.fc32",
				"libutempter-0:1.1.6-18.fc32",
				"libnsl2-0:1.2.0-6.20180605git4a062cf.fc32",
				"libblkid-0:2.35.2-1.fc32",
				"sed-0:4.5-5.fc32",
			},
			nobest:   true,
			repofile: "testdata/libvirt-devel-fc32.xml",
		},
		{name: "should resolve pkgconf-pkg-config",
			requires: []string{
				"pkgconf-pkg-config",
				"fedora-release-server",
			},
			installs: []string{
				"glibc-langpack-en-0:2.31-4.fc32",
				"glibc-common-0:2.31-4.fc32",
				"fedora-release-common-0:32-3",
				"fedora-release-server-0:32-3",
				"filesystem-0:3.14-2.fc32",
				"ncurses-libs-0:6.1-15.20191109.fc32",
				"glibc-0:2.31-4.fc32",
				"tzdata-0:2020a-1.fc32",
				"ncurses-base-0:6.1-15.20191109.fc32",
				"libgcc-0:10.2.1-1.fc32",
				"setup-0:2.13.6-2.fc32",
				"pkgconf-0:1.6.3-3.fc32",
				"pkgconf-m4-0:1.6.3-3.fc32",
				"libpkgconf-0:1.6.3-3.fc32",
				"bash-0:5.0.17-1.fc32",
				"fedora-repos-0:32-6",
				"fedora-gpg-keys-0:32-6",
				"pkgconf-pkg-config-0:1.6.3-3.fc32",
				"basesystem-0:11-9.fc32",
			},
			nobest:   false,
			repofile: "testdata/pkgconf-pkg-config-fc32.xml",
		},
		{name: "should resolve libvirt-daemon",
			requires: []string{
				"libvirt-daemon",
				"fedora-release-server",
				"glibc-langpack-en",
				"coreutils-single",
				"libcurl-minimal",
			},
			installs: []string{
				"keyutils-libs-0:1.6-4.fc32",
				"filesystem-0:3.14-2.fc32",
				"iproute-tc-0:5.7.0-1.fc32",
				"zlib-0:1.2.11-21.fc32",
				"bash-0:5.0.17-1.fc32",
				"libuuid-0:2.35.2-1.fc32",
				"qrencode-libs-0:4.0.2-5.fc32",
				"libcom_err-0:1.45.5-3.fc32",
				"lz4-libs-0:1.9.1-2.fc32",
				"alternatives-0:1.11-6.fc32",
				"openssl-libs-1:1.1.1g-1.fc32",
				"expat-0:2.2.8-2.fc32",
				"libssh-config-0:0.9.5-1.fc32",
				"libgpg-error-0:1.36-3.fc32",
				"libattr-0:2.4.48-8.fc32",
				"ncurses-base-0:6.1-15.20191109.fc32",
				"libselinux-0:3.0-5.fc32",
				"libunistring-0:0.9.10-7.fc32",
				"libnl3-0:3.5.0-2.fc32",
				"libpcap-14:1.9.1-3.fc32",
				"gnutls-0:3.6.15-1.fc32",
				"libxml2-0:2.9.10-7.fc32",
				"setup-0:2.13.6-2.fc32",
				"libffi-0:3.1-24.fc32",
				"libmount-0:2.35.2-1.fc32",
				"libvirt-libs-0:6.1.0-4.fc32",
				"dbus-libs-1:1.12.20-1.fc32",
				"ca-certificates-0:2020.2.41-1.1.fc32",
				"psmisc-0:23.3-3.fc32",
				"xz-libs-0:5.2.5-1.fc32",
				"iproute-0:5.7.0-1.fc32",
				"openldap-0:2.4.47-5.fc32",
				"libidn2-0:2.3.0-2.fc32",
				"acl-0:2.2.53-5.fc32",
				"libacl-0:2.2.53-5.fc32",
				"libgcc-0:10.2.1-1.fc32",
				"libmnl-0:1.0.4-11.fc32",
				"libtirpc-0:1.2.6-1.rc4.fc32",
				"libargon2-0:20171227-4.fc32",
				"libcap-ng-0:0.7.11-1.fc32",
				"device-mapper-0:1.02.171-1.fc32",
				"mpfr-0:4.0.2-5.fc32",
				"libcurl-minimal-0:7.69.1-6.fc32",
				"linux-atm-libs-0:2.5.1-26.fc32",
				"systemd-pam-0:245.8-2.fc32",
				"sed-0:4.5-5.fc32",
				"systemd-libs-0:245.8-2.fc32",
				"gzip-0:1.10-2.fc32",
				"krb5-libs-0:1.18.2-22.fc32",
				"crypto-policies-0:20200619-1.git781bbd4.fc32",
				"dbus-common-1:1.12.20-1.fc32",
				"nettle-0:3.5.1-5.fc32",
				"numactl-libs-0:2.0.12-4.fc32",
				"libtasn1-0:4.16.0-1.fc32",
				"libsigsegv-0:2.11-10.fc32",
				"libsepol-0:3.0-4.fc32",
				"polkit-0:0.116-7.fc32",
				"json-c-0:0.13.1-13.fc32",
				"glibc-common-0:2.31-4.fc32",
				"dbus-broker-0:24-1.fc32",
				"audit-libs-0:3.0-0.19.20191104git1c2f876.fc32",
				"nmap-ncat-2:7.80-4.fc32",
				"tzdata-0:2020a-1.fc32",
				"device-mapper-libs-0:1.02.171-1.fc32",
				"shadow-utils-2:4.8.1-2.fc32",
				"fedora-repos-0:32-6",
				"libfdisk-0:2.35.2-1.fc32",
				"pcre2-0:10.35-6.fc32",
				"fedora-release-common-0:32-3",
				"libsmartcols-0:2.35.2-1.fc32",
				"dmidecode-1:3.2-5.fc32",
				"pcre2-syntax-0:10.35-6.fc32",
				"bzip2-libs-0:1.0.8-2.fc32",
				"libstdc++-0:10.2.1-1.fc32",
				"libnghttp2-0:1.41.0-1.fc32",
				"libxcrypt-0:4.4.17-1.fc32",
				"libdb-0:5.3.28-40.fc32",
				"glib2-0:2.64.5-1.fc32",
				"elfutils-default-yama-scope-0:0.181-1.fc32",
				"systemd-rpm-macros-0:245.8-2.fc32",
				"libnsl2-0:1.2.0-6.20180605git4a062cf.fc32",
				"glibc-0:2.31-4.fc32",
				"libsemanage-0:3.0-3.fc32",
				"libgcrypt-0:1.8.5-3.fc32",
				"systemd-0:245.8-2.fc32",
				"libvirt-daemon-0:6.1.0-4.fc32",
				"polkit-libs-0:0.116-7.fc32",
				"p11-kit-trust-0:0.23.21-2.fc32",
				"fedora-gpg-keys-0:32-6",
				"iptables-libs-0:1.8.4-9.fc32",
				"kmod-libs-0:27-1.fc32",
				"libutempter-0:1.1.6-18.fc32",
				"libcap-0:2.26-7.fc32",
				"ncurses-libs-0:6.1-15.20191109.fc32",
				"gmp-1:6.1.2-13.fc32",
				"cyrus-sasl-0:2.1.27-4.fc32",
				"libverto-0:0.3.0-9.fc32",
				"readline-0:8.0-4.fc32",
				"polkit-pkla-compat-0:0.1-16.fc32",
				"libnetfilter_conntrack-0:1.0.7-4.fc32",
				"coreutils-single-0:8.32-4.fc32.1",
				"libssh-0:0.9.5-1.fc32",
				"kmod-0:27-1.fc32",
				"util-linux-0:2.35.2-1.fc32",
				"libseccomp-0:2.5.0-3.fc32",
				"grep-0:3.3-4.fc32",
				"glibc-langpack-en-0:2.31-4.fc32",
				"p11-kit-0:0.23.21-2.fc32",
				"libblkid-0:2.35.2-1.fc32",
				"libwsman1-0:2.6.8-12.fc32",
				"cryptsetup-libs-0:2.3.4-1.fc32",
				"mozjs60-0:60.9.0-5.fc32",
				"elfutils-libelf-0:0.181-1.fc32",
				"libpwquality-0:1.4.2-2.fc32",
				"fedora-release-server-0:32-3",
				"cyrus-sasl-gssapi-0:2.1.27-4.fc32",
				"gawk-0:5.0.1-7.fc32",
				"basesystem-0:11-9.fc32",
				"numad-0:0.5-31.20150602git.fc32",
				"libssh2-0:1.9.0-5.fc32",
				"elfutils-libs-0:0.181-1.fc32",
				"dbus-1:1.12.20-1.fc32",
				"yajl-0:2.1.0-14.fc32",
				"pam-0:1.3.1-26.fc32",
				"cyrus-sasl-lib-0:2.1.27-4.fc32",
				"libnfnetlink-0:1.0.1-17.fc32",
				"pcre-0:8.44-1.fc32",
				"cracklib-0:2.9.6-22.fc32",
			},
			repofile: "testdata/libvirt-daemon-fc32.xml",
		},
	}

	focus := false
	for _, tt := range tests {
		if tt.focus == true {
			focus = true
			break
		}
	}
	for _, tt := range tests {
		if focus != tt.focus {
			continue
		}
		t.Run(tt.name, func(t *testing.T) {
			g := NewGomegaWithT(t)
			f, err := os.Open(tt.repofile)
			g.Expect(err).ToNot(HaveOccurred())
			defer f.Close()
			repo := &api.Repository{}
			err = xml.NewDecoder(f).Decode(repo)
			g.Expect(err).ToNot(HaveOccurred())

			resolver := NewResolver(tt.nobest)
			packages := []*api.Package{}
			for i, _ := range repo.Packages {
				packages = append(packages, &repo.Packages[i])
			}
			err = resolver.LoadInvolvedPackages(packages, nil, nil)
			g.Expect(err).ToNot(HaveOccurred())
			err = resolver.ConstructRequirements(tt.requires)
			g.Expect(err).ToNot(HaveOccurred())
			install, _, _, err := resolver.Resolve()
			g.Expect(err).ToNot(HaveOccurred())
			g.Expect(pkgToString(install)).To(ConsistOf(tt.installs))
		})
	}
}

func TestNewResolver(t *testing.T) {
	tests := []struct {
		name     string
		packages []*api.Package
		requires []string
		install  []string
		exclude  []string
		solvable bool
		focus    bool
		nobest   bool
	}{
		{name: "with indirect dependency", packages: []*api.Package{
			newPkg("testa", "1", []string{"testa", "a", "b"}, []string{"d", "g"}, []string{}),
			newPkg("testb", "1", []string{"testb", "c"}, []string{}, []string{}),
			newPkg("testc", "1", []string{"testc", "d"}, []string{}, []string{}),
			newPkg("testd", "1", []string{"testd", "e", "f", "g"}, []string{"h"}, []string{}),
			newPkg("teste", "1", []string{"teste", "h"}, []string{}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1", "testc-0:1", "testd-0:1", "teste-0:1"},
			exclude:  []string{"testb-0:1"},
			solvable: true,
		},
		{name: "with circular dependency", packages: []*api.Package{
			newPkg("testa", "1", []string{"testa", "a", "b"}, []string{"d", "g"}, []string{}),
			newPkg("testb", "1", []string{"testb", "c"}, []string{}, []string{}),
			newPkg("testc", "1", []string{"testc", "d"}, []string{}, []string{}),
			newPkg("testd", "1", []string{"testd", "e", "f", "g"}, []string{"h"}, []string{}),
			newPkg("teste", "1", []string{"teste", "h"}, []string{"a"}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1", "testc-0:1", "testd-0:1", "teste-0:1"},
			exclude:  []string{"testb-0:1"},
			solvable: true,
		},
		{name: "with an unresolvable dependency", packages: []*api.Package{
			newPkg("testa", "1", []string{"testa", "a", "b"}, []string{"d"}, []string{}),
		}, requires: []string{
			"testa",
		},
			solvable: false,
		},
		{name: "with two sources to choose from, should use the newer one", packages: []*api.Package{
			newPkg("testa", "1", []string{"testa", "a", "b"}, []string{"d"}, []string{"testa", "a"}),
			newPkg("testb", "1", []string{"testb", "d"}, []string{}, []string{}),
			newPkg("testb", "2", []string{"testb", "d"}, []string{}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1", "testb-0:2"},
			exclude:  []string{},
			solvable: true,
		},
		{name: "with two sources to choose from, should use the newer one with nobest", packages: []*api.Package{
			newPkg("testa", "1", nil, []string{"testb"}, nil),
			newPkg("testb", "1", nil, []string{}, []string{}),
			newPkg("testb", "2", nil, []string{}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1", "testb-0:2"},
			exclude:  []string{"testb-0:1"},
			solvable: true,
			nobest:   true,
		},
		{name: "with two sources to choose for two packages, should use the newer ones with nobest and circular dependency", packages: []*api.Package{
			newPkg("testa", "1", []string{"a", "b"}, []string{"d"}, []string{"testa", "a"}),
			newPkg("testb", "1", []string{"d"}, []string{}, []string{}),
			newPkg("testb", "2", []string{"d"}, []string{"teste"}, []string{}),
			newPkg("teste", "1", []string{"e"}, []string{"testa"}, []string{}),
			newPkg("teste", "2", []string{"e"}, []string{"testa", "a"}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1", "testb-0:2", "teste-0:2"},
			exclude:  []string{"testb-0:1", "teste-0:1"},
			solvable: true,
			nobest:   true,
		},
		{name: "with two sources to choose for two packages, should use the newer ones with nobest", packages: []*api.Package{
			newPkg("testa", "1", []string{"a", "b"}, []string{"d"}, []string{"testa", "a"}),
			newPkg("testb", "1", []string{"d"}, []string{}, []string{}),
			newPkg("testb", "2", []string{"d"}, []string{"teste"}, []string{}),
			newPkg("teste", "1", []string{"e"}, []string{}, []string{}),
			newPkg("teste", "2", []string{"e"}, []string{}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1", "testb-0:2", "teste-0:2"},
			exclude:  []string{"testb-0:1", "teste-0:1"},
			solvable: true,
			nobest:   true,
		},
		{name: "with one source only referencing itself", packages: []*api.Package{
			newPkg("testa", "1", []string{"testa"}, []string{}, []string{}),
		}, requires: []string{
			"testa",
		},
			install:  []string{"testa-0:1"},
			exclude:  []string{},
			solvable: true,
		},
		// TODO: Add test cases.
	}
	focus := false
	for _, tt := range tests {
		if tt.focus == true {
			focus = true
			break
		}
	}
	for _, tt := range tests {
		if focus != tt.focus {
			continue
		}
		t.Run(tt.name, func(t *testing.T) {
			resolver := NewResolver(tt.nobest)
			err := resolver.LoadInvolvedPackages(tt.packages, nil, nil)
			if err != nil {
				t.Fail()
			}
			err = resolver.ConstructRequirements(tt.requires)
			if err != nil {
				fmt.Println(err)
				t.Fail()
			}
			install, exclude, _, err := resolver.Resolve()
			g := NewGomegaWithT(t)
			if tt.solvable {
				g.Expect(err).ToNot(HaveOccurred())
			} else {
				g.Expect(err).To(HaveOccurred())
				return
			}
			g.Expect(pkgToString(install)).To(ConsistOf(tt.install))
			g.Expect(pkgToString(exclude)).To(ConsistOf(tt.exclude))
		})
	}
}

func newPkg(name string, version string, provides []string, requires []string, conflicts []string) *api.Package {
	pkg := &api.Package{}
	pkg.Name = name
	pkg.Version = api.Version{Ver: version}
	for _, req := range requires {
		pkg.Format.Requires.Entries = append(pkg.Format.Requires.Entries, api.Entry{Name: req})
	}
	pkg.Format.Provides.Entries = append(pkg.Format.Provides.Entries, api.Entry{
		Name:  name,
		Flags: "EQ",
		Ver:   version,
	})
	for _, req := range provides {
		pkg.Format.Provides.Entries = append(pkg.Format.Provides.Entries, api.Entry{Name: req})
	}
	for _, req := range conflicts {
		pkg.Format.Conflicts.Entries = append(pkg.Format.Conflicts.Entries, api.Entry{Name: req})
	}

	return pkg
}

func strToPkg(wanted []string, given []*api.Package) (resolved []*api.Package) {
	m := map[string]*api.Package{}
	for _, p := range given {
		m[p.String()] = p
	}
	for _, w := range wanted {
		resolved = append(resolved, m[w])
	}
	return resolved
}

func pkgToString(given []*api.Package) (resolved []string) {
	for _, p := range given {
		resolved = append(resolved, p.String())
	}
	return
}
